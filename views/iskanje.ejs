<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./partials/head'); %>
    <link rel="stylesheet" href="public/css/iskanje.css" />
  </head>
  <body class="flex-center">
    <%- include('./partials/body-common'); %>

    <div id="bg"></div>
    <div id="main" class="hidden">
      <div class="live-dot-container" @click="autoRefresh = !autoRefresh">
        <div class="live-dot" :class="{live: autoRefresh}"></div>
      </div>
      <div class="tracker-shortcut">
        <img @click="openPrompt" id="trackerBtn" src="public/img/gps.png" alt="Iskanje avtobusa" />
      </div>

      <div class="block">
        <!-- INPUT SECTION -->
        <div class="section" id="input">
          <input
            type="text"
            name="postaja"
            placeholder="Postaja"
            autocomplete="off"
            spellcheck="false"
            v-model="input"
            @input="onInput"
          />
          <div class="reset flex-center" @click="resetInput">×</div>
        </div>

        <!-- NEDAVNA ISKANJA SECTION -->
        <div class="section postaje" v-if="!input && filteredHistory.length">
          <div class="postaja" v-for="stop in filteredHistory" @click="input = stop.name">{{ stop.name }}</div>
        </div>

        <!-- ISKANJE FILTER SECTION -->
        <div class="section postaje" v-if="searchResults.length">
          <div
            class="postaja"
            :class="{selected: input === stopName}"
            v-for="stopName in searchResults"
            @click="onInput() || (input = stopName)"
          >
            {{ stopName }}
          </div>
        </div>

        <!-- POSTAJE MOŽNOSTI SECTION -->
        <div class="section postaje" v-if="stopOptions.length">
          <div
            v-for="option in stopOptions"
            class="postaja"
            @click="selectStop(option.ref_id)"
            :class="{selected: selectedStop.ref_id === option.ref_id}"
          >
            {{ option.text }}
          </div>
        </div>

        <!-- LINIJE SECTION -->
        <div class="section" id="linije" v-if="!loading && arrivals.length">
          <div class="linija" v-for="r in arrivals">
            <div class="stevilka" @click="showMap(r[0])">{{ r[0].key }}</div>
            <div class="prihodi" @click="eta=!eta" :style="{'text-decoration':dataExpired?'line-through':''}">
              <span v-for="arrival in r.slice(0,3)" :class="{garaza:arrival.v_garazo}">{{
                eta ? arrival.minutes + ' min' : arrival.time
              }}</span>
            </div>
          </div>
        </div>

        <span id="loadingText" v-if="loading">Iskanje ..</span>
        <span id="emptyText" v-if="selectedStop.name && !loading && !arrivals.length">Ni rezultatov.</span>
        <span id="errorText" v-if="error">[error]</span>
      </div>
    </div>

    <img src="public/img/busek.png" id="busek" />

    <script>
      // --- IZLETEK (BUSEK)
      const random = (min, max) => min + Math.random() * (max - min);

      function izletek() {
        $('#busek').style.animation = '';
        setTimeout(() => ($('#busek').style.animation = `izletek ${window.innerWidth / 50}s linear`), 100);
        $('#busek').onanimationend = () => setTimeout(izletek, random(100_000, 300_000));
      }

      setTimeout(izletek, random(100_000, 300_000));
    </script>

    <!-- <script src="public/js/vue.global.js"></script> -->
    <script src="public/js/vendor/vue.global.js"></script>
    <script src="public/js/stops.js"></script>
    <script src="public/js/iskanje.js"></script>
    <script src="public/js/pwa/pwa.js"></script>
  </body>
</html>
